<script src="p5.js"></script>
<script src="StackBlur.js"></script>
<script src="lsystem.js"></script>
<script>

  var angle = 60;
  var d = 100;
  var iter = 8;

  var w = 1920;
  var h = 1080;
  var x = w * .3;
  var y = h * .5;
  var r = -135;

  var cInc = -0.001;

  var c;
  var system = new LSystem({
    axiom: 'f',
    rules: {
      'f': ">gf*[+>fi]",
      'g': "[+gf[>h]]",
      'h': "[f[g]]",
      'i': "[f[gh]]"
    },
    renderRules: {
      'b': function () {
        console.log('blurring');
        stackBlurCanvasRGBA('defaultCanvas', 0, 0, w, h, 1);
        console.log('blurred');
      },
      'f': (function () {
        var i = 0;
        return function () {
          stroke(c);
          noFill();
          strokeWeight(0.5);
          line(0, 0, d, 0);
          translate(d,0);
          if (i++ % 100 === 0) {
            console.log('blur');
            stackBlurCanvasRGBA('defaultCanvas', 0, 0, w, h, 1);
          }
        }
      }()),
      'g': function () {
        ellipse(0, 0, d/2, d/2);
        translate(d, 0);
      },
      'h': function () {
        ellipse(0, 0, d/3, d/3),
        translate(2 * d / 3, 0);
      },
      'i': function () {
        ellipse(0, 0, d/4, d/4),
        translate(2 * d / 4, 0);
      },

      '<': function () {
        c = color((c.hsba[0] - cInc) % 360, c.hsba[1], c.hsba[2], c.hsba[3]);
      },
      '>': function () {
        c = color((c.hsba[0] + cInc) % 360, c.hsba[1], c.hsba[2], c.hsba[3]);
      },
      '[': function () {
        push();
      },
      ']': function () {
        pop();
      },
      '*': function () {
        angle += 30
      },
      '+': function () {
        rotate(angle);
      },
      '-': function () {
        rotate(-1 * angle);
      }
    }
  });

  function setup() {
    angleMode(DEGREES);
    colorMode(HSB);
    c = color(80, 80, 80, 0.4);

    frameRate(1);
    createCanvas(w, h);
    noFill();
    background(color(0,0,0,1));
    translate(x, y);
    rotate(r);
    push();
    system.reset();
    system.simulate(iter);
    system.render();
    pop();
  }


</script>

